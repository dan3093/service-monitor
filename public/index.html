<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .service-card {
            transition: transform 0.2s;
        }
        .service-card:hover {
            transform: translateY(-5px);
        }
        .status-up {
            background-color: #d1f5d3;
        }
        .status-down {
            background-color: #f8d7da;
        }
        .status-unknown {
            background-color: #f8f9fa;
        }
        .service-url {
            font-size: 0.9em;
            color: #6c757d;
        }
        .response-time {
            font-weight: bold;
        }
        .error-message {
            font-size: 0.85em;
            color: #dc3545;
        }
        .notification-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .notification-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .uptime-badge {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Service Monitor</h1>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                    <i class="bi bi-plus-circle"></i> Add Service
                </button>
                <button id="checkNowBtn" class="btn btn-secondary ms-2">
                    <i class="bi bi-arrow-repeat"></i> Check Now
                </button>
                <button class="btn btn-info ms-2" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    <i class="bi bi-bell"></i> Notifications
                </button>
            </div>
        </div>
        
        <div id="servicesContainer" class="row">
            <!-- Service cards will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Add Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addServiceModalLabel">Add New Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addServiceForm">
                        <div class="mb-3">
                            <label for="serviceName" class="form-label">Service Name</label>
                            <input type="text" class="form-control" id="serviceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="serviceUrl" class="form-label">Service URL</label>
                            <input type="url" class="form-control" id="serviceUrl" required>
                        </div>
                        <div class="mb-3">
                            <label for="serviceTimeout" class="form-label">Timeout (ms)</label>
                            <input type="number" class="form-control" id="serviceTimeout" value="5000">
                        </div>
                        <div class="mb-3">
                            <label for="expectedStatus" class="form-label">Expected Status Code</label>
                            <input type="number" class="form-control" id="expectedStatus" value="200">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addServiceBtn">Add Service</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Service History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Service History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 id="historyServiceName" class="mb-3"></h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-primary">Uptime: <span id="historyUptime">0%</span></span>
                        </div>
                        <div>
                            <button id="refreshHistoryBtn" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-repeat"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="historyContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- History entries will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationsModalLabel">Notification Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationsForm">
                        <!-- Email Notifications -->
                        <div class="notification-section">
                            <div class="notification-header">
                                <i class="bi bi-envelope"></i> Email Notifications
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="emailEnabled">
                                <label class="form-check-label" for="emailEnabled">
                                    Enable Email Notifications
                                </label>
                            </div>
                            <div class="email-settings" id="emailSettings">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="smtpHost" class="form-label">SMTP Host</label>
                                        <input type="text" class="form-control" id="smtpHost">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="smtpPort" class="form-label">SMTP Port</label>
                                        <input type="number" class="form-control" id="smtpPort" value="587">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="smtpSecure">
                                            <label class="form-check-label" for="smtpSecure">
                                                Use SSL Connection (Port 465)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="smtpRequireTls">
                                            <label class="form-check-label" for="smtpRequireTls">
                                                Require TLS (Port 587)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="smtpUser" class="form-label">SMTP Username</label>
                                        <input type="text" class="form-control" id="smtpUser">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="smtpPass" class="form-label">SMTP Password</label>
                                        <input type="password" class="form-control" id="smtpPass">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="emailFrom" class="form-label">From Email</label>
                                        <input type="email" class="form-control" id="emailFrom">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="emailTo" class="form-label">To Email</label>
                                        <input type="email" class="form-control" id="emailTo">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-secondary" id="testEmailBtn">
                                        <i class="bi bi-send"></i> Test Email
                                    </button>
                                    <span id="emailTestResult" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Teams Notifications -->
                        <div class="notification-section">
                            <div class="notification-header">
                                <i class="bi bi-microsoft"></i> Microsoft Teams Notifications
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="teamsEnabled">
                                <label class="form-check-label" for="teamsEnabled">
                                    Enable Teams Notifications
                                </label>
                            </div>
                            <div class="teams-settings" id="teamsSettings">
                                <div class="mb-3">
                                    <label for="teamsWebhookUrl" class="form-label">Webhook URL</label>
                                    <input type="url" class="form-control" id="teamsWebhookUrl">
                                    <div class="form-text">
                                        Create a webhook in your Teams channel and paste the URL here.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-secondary" id="testTeamsBtn">
                                        <i class="bi bi-send"></i> Test Teams Notification
                                    </button>
                                    <span id="teamsTestResult" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SMS Notifications -->
                        <div class="notification-section">
                            <div class="notification-header">
                                <i class="bi bi-phone"></i> SMS Notifications (Twilio)
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="smsEnabled">
                                <label class="form-check-label" for="smsEnabled">
                                    Enable SMS Notifications
                                </label>
                            </div>
                            <div class="sms-settings" id="smsSettings">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="twilioAccountSid" class="form-label">Account SID</label>
                                        <input type="text" class="form-control" id="twilioAccountSid">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="twilioAuthToken" class="form-label">Auth Token</label>
                                        <input type="password" class="form-control" id="twilioAuthToken">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="smsFrom" class="form-label">From Number</label>
                                        <input type="text" class="form-control" id="smsFrom">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="smsTo" class="form-label">To Number</label>
                                        <input type="text" class="form-control" id="smsTo">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-secondary" id="testSmsBtn">
                                        <i class="bi bi-send"></i> Test SMS
                                    </button>
                                    <span id="smsTestResult" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNotificationsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to fetch and display services
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();
                
                const container = document.getElementById('servicesContainer');
                container.innerHTML = '';
                
                if (services.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                No services configured. Add a service to get started.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                services.forEach(service => {
                    const card = createServiceCard(service);
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading services:', error);
                document.getElementById('servicesContainer').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Error loading services. Please try again.
                        </div>
                    </div>
                `;
            }
        }
        
        // Function to create a service card element
        function createServiceCard(service) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const statusClass = service.status === 'up' ? 'status-up' : 
                               service.status === 'down' ? 'status-down' : 'status-unknown';
            
            const statusIcon = service.status === 'up' ? 'bi-check-circle-fill text-success' : 
                              service.status === 'down' ? 'bi-x-circle-fill text-danger' : 'bi-question-circle-fill text-secondary';
            
            const statusText = service.status === 'up' ? 'Up' : 
                              service.status === 'down' ? 'Down' : 'Unknown';
            
            col.innerHTML = `
                <div class="card service-card ${statusClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title">${service.name}</h5>
                            <button class="btn btn-sm btn-outline-danger remove-service" data-name="${service.name}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <p class="service-url mb-2">
                            <a href="${service.url}" target="_blank">${service.url}</a>
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge ${service.status === 'up' ? 'bg-success' : service.status === 'down' ? 'bg-danger' : 'bg-secondary'}">
                                <i class="bi ${statusIcon}"></i> ${statusText}
                            </span>
                            <span class="response-time">${service.responseTime ? service.responseTime + 'ms' : 'N/A'}</span>
                        </div>
                        <div class="d-flex justify-content-between small text-muted mb-2">
                            <span>Status: ${service.statusCode || 'N/A'}</span>
                            <span>${service.lastChecked ? new Date(service.lastChecked).toLocaleTimeString() : 'Never'}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="uptime-badge">Uptime: ${service.uptime || '0.00'}%</span>
                            <button class="btn btn-sm btn-outline-primary view-history" data-name="${service.name}">
                                <i class="bi bi-clock-history"></i> History
                            </button>
                        </div>
                        ${service.error ? `<div class="error-message mt-2">${service.error}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Add event listener to remove button
            const removeBtn = col.querySelector('.remove-service');
            removeBtn.addEventListener('click', async () => {
                if (confirm(`Are you sure you want to remove ${service.name}?`)) {
                    try {
                        await fetch(`/api/services/${encodeURIComponent(service.name)}`, {
                            method: 'DELETE'
                        });
                        loadServices(); // Reload the services list
                    } catch (error) {
                        console.error('Error removing service:', error);
                        alert('Error removing service');
                    }
                }
            });
            
            // Add event listener to history button
            const historyBtn = col.querySelector('.view-history');
            historyBtn.addEventListener('click', () => {
                showServiceHistory(service.name);
            });
            
            return col;
        }
        
        // Show service history in modal
        async function showServiceHistory(serviceName) {
            try {
                const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}/history`);
                const historyData = await response.json();
                
                document.getElementById('historyServiceName').textContent = historyData.name;
                document.getElementById('historyUptime').textContent = historyData.uptime + '%';
                
                const container = document.getElementById('historyContainer');
                container.innerHTML = '';
                
                if (historyData.history.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No history available for this service.</div>';
                    return;
                }
                
                // Reverse the history to show newest first
                const history = [...historyData.history].reverse();
                
                history.forEach(entry => {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'card mb-2';
                    
                    const statusClass = entry.status === 'up' ? 'bg-success' : 'bg-danger';
                    const statusText = entry.status === 'up' ? 'Operational' : 'Degraded';
                    
                    entryEl.innerHTML = `
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge ${statusClass}">${statusText}</span>
                                <small class="text-muted">${new Date(entry.timestamp).toLocaleString()}</small>
                            </div>
                            ${entry.statusCode ? `<div class="small text-muted">Status Code: ${entry.statusCode}</div>` : ''}
                            ${entry.responseTime ? `<div class="small text-muted">Response Time: ${entry.responseTime}ms</div>` : ''}
                            ${entry.error ? `<div class="small text-danger">Error: ${entry.error}</div>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(entryEl);
                });
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading service history:', error);
                alert('Error loading service history');
            }
        }
        
        // Refresh history in modal
        document.getElementById('refreshHistoryBtn').addEventListener('click', () => {
            const serviceName = document.getElementById('historyServiceName').textContent;
            if (serviceName) {
                showServiceHistory(serviceName);
            }
        });
        
        // Add service form submission
        document.getElementById('addServiceBtn').addEventListener('click', async () => {
            const name = document.getElementById('serviceName').value;
            const url = document.getElementById('serviceUrl').value;
            const timeout = parseInt(document.getElementById('serviceTimeout').value) || 5000;
            const expectedStatus = parseInt(document.getElementById('expectedStatus').value) || 200;
            
            try {
                const response = await fetch('/api/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url, timeout, expectedStatus })
                });
                
                if (response.ok) {
                    // Reset form and close modal
                    document.getElementById('addServiceForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addServiceModal'));
                    modal.hide();
                    
                    // Reload services
                    loadServices();
                } else {
                    const error = await response.json();
                    alert('Error adding service: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding service:', error);
                alert('Error adding service');
            }
        });
        
        // Check now button
        document.getElementById('checkNowBtn').addEventListener('click', async () => {
            try {
                const btn = document.getElementById('checkNowBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
                
                await fetch('/api/services/check');
                await loadServices();
                
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Check Now';
            } catch (error) {
                console.error('Error checking services:', error);
                alert('Error checking services');
                
                // Re-enable button
                const btn = document.getElementById('checkNowBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Check Now';
            }
        });
        
        // Load notification settings
        async function loadNotificationSettings() {
            try {
                const response = await fetch('/api/notifications');
                const notifications = await response.json();
                
                // Email settings
                document.getElementById('emailEnabled').checked = notifications.email.enabled;
                document.getElementById('smtpHost').value = notifications.email.smtp.host || '';
                document.getElementById('smtpPort').value = notifications.email.smtp.port || 587;
                document.getElementById('smtpSecure').checked = notifications.email.smtp.secure || false;
                document.getElementById('smtpRequireTls').checked = notifications.email.smtp.requireTLS || true;
                document.getElementById('smtpUser').value = notifications.email.smtp.auth.user || '';
                // Don't set the password field if it's masked
                if (notifications.email.smtp.auth.pass !== '***') {
                    document.getElementById('smtpPass').value = notifications.email.smtp.auth.pass || '';
                }
                
                document.getElementById('emailFrom').value = notifications.email.from || '';
                document.getElementById('emailTo').value = notifications.email.to || '';
                
                // Teams settings
                document.getElementById('teamsEnabled').checked = notifications.teams.enabled;
                document.getElementById('teamsWebhookUrl').value = notifications.teams.webhookUrl || '';
                
                // SMS settings
                document.getElementById('smsEnabled').checked = notifications.sms.enabled;
                // Don't set the account SID field if it's masked
                if (notifications.sms.accountSid !== '***') {
                    document.getElementById('twilioAccountSid').value = notifications.sms.accountSid || '';
                }
                // Don't set the auth token field if it's masked
                if (notifications.sms.authToken !== '***') {
                    document.getElementById('twilioAuthToken').value = notifications.sms.authToken || '';
                }
                document.getElementById('smsFrom').value = notifications.sms.from || '';
                document.getElementById('smsTo').value = notifications.sms.to || '';
                
                // Toggle settings visibility based on enabled checkboxes
                toggleNotificationSettings();
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }
        
        // Toggle visibility of notification settings based on enabled checkboxes
        function toggleNotificationSettings() {
            document.getElementById('emailSettings').style.display = 
                document.getElementById('emailEnabled').checked ? 'block' : 'none';
                
            document.getElementById('teamsSettings').style.display = 
                document.getElementById('teamsEnabled').checked ? 'block' : 'none';
                
            document.getElementById('smsSettings').style.display = 
                document.getElementById('smsEnabled').checked ? 'block' : 'none';
        }
        
        // Save notification settings
        document.getElementById('saveNotificationsBtn').addEventListener('click', async () => {
            const notifications = {
                email: {
                    enabled: document.getElementById('emailEnabled').checked,
                    smtp: {
                        host: document.getElementById('smtpHost').value,
                        port: parseInt(document.getElementById('smtpPort').value) || 587,
                        secure: document.getElementById('smtpSecure').checked,
                        requireTLS: document.getElementById('smtpRequireTls').checked,
                        auth: {
                            user: document.getElementById('smtpUser').value,
                            pass: document.getElementById('smtpPass').value
                        }
                    },
                    from: document.getElementById('emailFrom').value,
                    to: document.getElementById('emailTo').value
                },
                teams: {
                    enabled: document.getElementById('teamsEnabled').checked,
                    webhookUrl: document.getElementById('teamsWebhookUrl').value
                },
                sms: {
                    enabled: document.getElementById('smsEnabled').checked,
                    accountSid: document.getElementById('twilioAccountSid').value,
                    authToken: document.getElementById('twilioAuthToken').value,
                    from: document.getElementById('smsFrom').value,
                    to: document.getElementById('smsTo').value
                }
            };
            
            try {
                const response = await fetch('/api/notifications', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notifications)
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('notificationsModal'));
                    modal.hide();
                    alert('Notification settings saved successfully');
                } else {
                    const error = await response.json();
                    alert('Error saving notification settings: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving notification settings:', error);
                alert('Error saving notification settings');
            }
        });
        
        // Test email notification
        document.getElementById('testEmailBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testEmailBtn');
            const result = document.getElementById('emailTestResult');
            
            try {
                btn.disabled = true;
                result.innerHTML = '<span class="text-info">Sending test email...</span>';
                
                const response = await fetch('/api/notifications/test/email', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    result.innerHTML = '<span class="text-success">Test email sent successfully!</span>';
                } else {
                    const error = await response.json();
                    result.innerHTML = `<span class="text-danger">Error: ${error.error}</span>`;
                }
            } catch (error) {
                console.error('Error sending test email:', error);
                result.innerHTML = '<span class="text-danger">Error sending test email</span>';
            } finally {
                btn.disabled = false;
            }
        });
        
        // Test Teams notification
        document.getElementById('testTeamsBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testTeamsBtn');
            const result = document.getElementById('teamsTestResult');
            
            try {
                btn.disabled = true;
                result.innerHTML = '<span class="text-info">Sending test notification...</span>';
                
                const response = await fetch('/api/notifications/test/teams', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    result.innerHTML = '<span class="text-success">Test notification sent successfully!</span>';
                } else {
                    const error = await response.json();
                    result.innerHTML = `<span class="text-danger">Error: ${error.error}</span>`;
                }
            } catch (error) {
                console.error('Error sending test Teams notification:', error);
                result.innerHTML = '<span class="text-danger">Error sending test notification</span>';
            } finally {
                btn.disabled = false;
            }
        });
        
        // Test SMS notification
        document.getElementById('testSmsBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testSmsBtn');
            const result = document.getElementById('smsTestResult');
            
            try {
                btn.disabled = true;
                result.innerHTML = '<span class="text-info">Sending test SMS...</span>';
                
                const response = await fetch('/api/notifications/test/sms', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    result.innerHTML = '<span class="text-success">Test SMS sent successfully!</span>';
                } else {
                    const error = await response.json();
                    result.innerHTML = `<span class="text-danger">Error: ${error.error}</span>`;
                }
            } catch (error) {
                console.error('Error sending test SMS:', error);
                result.innerHTML = '<span class="text-danger">Error sending test SMS</span>';
            } finally {
                btn.disabled = false;
            }
        });
        
        // Add event listeners to toggle settings visibility
        document.getElementById('emailEnabled').addEventListener('change', toggleNotificationSettings);
        document.getElementById('teamsEnabled').addEventListener('change', toggleNotificationSettings);
        document.getElementById('smsEnabled').addEventListener('change', toggleNotificationSettings);
        
        // Load services and notification settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadServices();
            loadNotificationSettings();
            
            // Refresh every 30 seconds
            setInterval(loadServices, 30000);
        });
    </script>
</body>
</html>